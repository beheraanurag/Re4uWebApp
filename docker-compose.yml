# Re4u server stack: PostgreSQL + Directus + Caddy reverse proxy
# Usage: cp .env.example .env && docker compose up -d
# See docs/docker.md for details.
# With proxy: http://localhost/ -> Next.js, http://localhost/directus/ -> Directus

services:
  proxy:
    image: caddy:2-alpine
    container_name: re4u-proxy
    restart: unless-stopped
    ports:
      - "${PROXY_HTTP_PORT:-80}:80"
      - "${PROXY_HTTPS_PORT:-443}:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
    environment:
      PROXY_HOST: ${PROXY_HOST:-localhost}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      directus:
        condition: service_healthy
    networks:
      - re4u

  db:
    image: postgres:16-alpine
    container_name: re4u-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER:-directus}
      POSTGRES_PASSWORD: ${DB_PASSWORD:?Set DB_PASSWORD in .env}
      POSTGRES_DB: ${DB_NAME:-directus}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - directus_db_data:/var/lib/postgresql/data
    ports:
      - "${DB_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-directus} -d ${DB_NAME:-directus}"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - re4u

  directus:
    image: directus/directus:11
    container_name: re4u-directus
    restart: unless-stopped
    ports:
      - "${DIRECTUS_PORT:-8055}:8055"
    volumes:
      - directus_uploads:/directus/uploads
      - ./directus/extensions:/directus/extensions
    environment:
      DB_CLIENT: pg
      DB_HOST: db
      DB_PORT: 5432
      DB_DATABASE: ${DB_NAME:-directus}
      DB_USER: ${DB_USER:-directus}
      DB_PASSWORD: ${DB_PASSWORD:?Set DB_PASSWORD in .env}
      ADMIN_EMAIL: ${DIRECTUS_ADMIN_EMAIL:?Set DIRECTUS_ADMIN_EMAIL in .env}
      ADMIN_PASSWORD: ${DIRECTUS_ADMIN_PASSWORD:?Set DIRECTUS_ADMIN_PASSWORD in .env}
      PUBLIC_URL: ${DIRECTUS_URL:?Set DIRECTUS_URL in .env}
      KEY: ${DIRECTUS_SECRET:?Set DIRECTUS_SECRET in .env}
      MCP_ENABLED: "true"
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:8055/server/health',r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - re4u

volumes:
  directus_db_data:
    name: re4u_directus_db_data
  directus_uploads:
    name: re4u_directus_uploads

networks:
  re4u:
    name: re4u_network
    driver: bridge
